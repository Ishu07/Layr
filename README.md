## Batnode Prototype


## To Do

1. For file upload and retrieval, offline nodes are skipped and a new node is chosen.
2. When user lists their files with batchain, the files are audited and the results are displayed.
3. The user can patch any missing or corrupt file shards on the network with a batchain CLI command.
4. How the patch executes depends on the cause of the audit failure.
5. If an audit fails due to corrupted shard data, the patch will distribute a new shard copy and then send the failing node a message that writes to a file saying that the shard can be deleted as it is no longer being used by the data owner.
6. When a node disconnects and reconnects, it generates a new ID. This can cause problems about invalid contacts in other nodes' databases.
7. Make getOtherBatNodeContact use node ID rather than host as criterion to test for equivalence.
8. Integrate with stellar cryptocurrency to charge a static one-time upload fee.
9. Incentivization with blockchain: incentivization of making data available and keeping it integrous. The former is achieved by the upload fee. How to incentivize the latter?
10. getOtherBatNodeContact uses id instead of hostname

## Specification

#### Upload Single File

kd = kad node
bt = bat node
tkd = target kad node
tbt = target bat node

1. kd performs an iterativeFindNode for <= k kd nodes w/ closest ids to file id
2. kd returns those nodes contacts to bt
3. bt iterates through contacts until the following subroutine succeeds:
4. For each target kad node (tkd):
5. bt asks kd to send a broker_connectionRPC to tkd. Broker connection's payload is bt public conect tuple
6. tkd receives RPC and tells its target bat node (tbt) to send establish_connection tcp request to bt tuple
7. tkd simultaneously sends a success RPC to bt, containing tbt's public tuple
8. bt sends establish_connection tcp request to tbt
9. if bt receives the establish_connection request, it sends a standard store_file message in response
10. if tbt is instead the one to receive establish_connection request, it sends a ready_to_store message in response, and bt responds to that with standard store_file message
11. if bt does not receive a response with X amount of time, move onto the next tkd and try again, else, cease iteration
12. when tbt finishes receiving file, it initiates an iterative store on its tkd

Edge cases:
 - The node doesn't have enough allocated storage
 - The nodes are already connected from previous exchange, so both establish_connection requests go through, causing the file to be sent over twice



#### Retrieve Single File



#### Redefining a file as a group of shards: New versions of Upload and Retrieval




#### Shards and Avoiding Exceeding High Water Marks for JSON-based requests



#### BatNode's public ip/port changes



#### KadNode disconnects and reconnects



#### BatNode-KadNode Pair joins the network


#### BatNodes keep eachother alive



#### Discussion of Chosen NAT Traversal Strategies




### Demos

#### 1: Write a file across two nodes in a LAN.

`node1` will write to `node2`, which resides in another directory.

Starting condition:  
- `demo/batnode1/hosted` has an `example.txt` file.
- Delete any files in `demo/batnode2/hosted`.

1) cd into `demo/batnode1`
2) run `node batnode.js`
3) open a new terminal session and `cd` into `demo/batnode2`
4) run `node batnode.js`

Ending condition: `demo/batnode2/hosted` has a `example.txt-1` file.

#### 2: Distribute shards to multiple server nodes (hardcoded server contacts)

client node distributes shards to two server nodes

Starting condition:
- `demo/demo_upload/client-node/personal` has an `example.txt` and `test.pdf`
- `demo/demo_upload/server-node` and `server-node-2` directories have an `example.txt` and `test.pdf` files

1) `cd` into `demo/demo_upload/server-node`, and run `node batnode.js`. That server is now running.
2) Open a new terminal session, and `cd` into `demo/demo_upload/server-node-2` and do the same.
3) `cd` into `demo/demo_upload/client-node` and run `node batnode.js`

There should now be:
- shards files in `demo/demo_upload/client-node/shards`
- A manifest file in `demo/demo_upload/client-node/manifest`
- 4 (with current settings) shards in `demo/demo_upload/server-node/hosted` and `server-node-2/hosted`.

Run `git clean -xf` to have all the files generated by the demo wiped.


#### 3. Distribute shards to multiple server nodes (batnodes use kadnodes to locate viable hosts)

In this demo, all nodes are comprised of a batNode-kademliaNode pair. A bat node is responsible for transferring and storing file data, while a kademlia node is responsible for locating files and nodes on the network.

To run this demo, you will need three terminal windows.

First, clone the repo, `cd` into it, and install dependencies. Then, follow the commands below:

After npm installing, go into `node_modules/@kadenceproject/lib/node-kademlia.js`

In `node-kademlia.js`, add this to the `listen` method:
`this.use('BATNODE', handlers.batnode.bind(handlers))`
then add these methods to the `KademnliaNode` class itself:

```
  set batNode(node){
    this._batNode = node
  }

  get batNode(){
    return this._batNode
  }


  getOtherBatNodeContact(targetNode, callback) {
    let batcontact = this.batNode.address
    this.send('BATNODE', batcontact, targetNode, callback);
  };
```

After updating `node-kademlia.js`, it is time to update the file located here: `node_modules/@kadenceproject/lib/rules-kademlia.js`

Place the following code into the `KademliaRules` class

```
batnode(req, res) {
  let batnode = this.node.batNode
  res.send(batnode.address)
}
```


In the first terminal window:
1. `cd kad-bat-plugin/node1`
2. `rm -rf db`
3. `rm hosted/*`
4. `node node1.js`

In the second terminal window:
1. `cd kad-bat-plugin/node2`
2. `rm -rf dbb`
3. `rm hosted/*`
4. `node node2.js`

In the third terminal window:
1. `cd kad-bat-plugin/node3`
2. `rm -rf dbbb`
3. `rm manifest/*`
4. `rm shards/*`
5. `node node3.js`

What you will see:

In node3's folder, you should see 8 shards created in the shards folder and a single file generated in the manifest folder. You should then notice that the shards are distributed across nodes 1 and 2. Specifically, the shards in node3 should be found in the `hosted` folders of nodes 1 and 2.

You can then uncomment the `retrieveFile` line in node3.js, but replace the manifest filename with the name of the manifest generated when node3 executed `uploadFile`

#### Demo for CLI sample:
1. Same steps for node1 & node2 in above "3. Distribute shards to multiple server nodes (batnodes use kadnodes to locate viable hosts)".

   In the third terminal window:
    1. `cd kad-bat-plugin/node3`
    2. `rm -rf dbbb`
    3. `rm manifest/*`
    4. `rm shards/*`
    5. `node clinode3.js`
    
2. Open another(4th) terminal window, make sure your new window is in `kad-bat-plugin/node3`, otherwise the system can't verify the correct file path for you if you don't go to the client's directory.
Then select the options to upload/download/audit files while connecting to node1
  - Upload: `batchain-sample -u <filePath>`:
    `batchain-sample -u './personal/example.txt'`
  - Download: `batchain-sample -d <manifestFile>`(make sure don't modify the db folders under node1~3) 
  - Audit: `batchain-sample -a <manifestFile>`(make sure don't modify the db folders under node1~3)
3. If your server window keeps running, you can view your current uploaded lists in another window
  - `batchain -l`
4. You can always run `batchain -h` to review available command and options

#### Note:

For `npm`:
1. Run `npm install -g` before running any `batchain` option or command, make sure to
2. Need to run `npm install -g` when making bin changes
3. If "chalk" is not working for you, run `npm install chalk --save` to make the command line more colorful

For `yarn`:
1. Run `yarn link` to create a symbolic link between project directory and executable command
2. Open another terminal window, run `batchain` and you should see:
```
 Usage: batchain [options] [command]


  Commands:

    sample      see the sample nodes running
    help [cmd]  display help for [cmd]

  Options:

    -h, --help  output usage information
    -l, --list  view your list of uploaded files in BatChain network
  ```

#### Local CLI demo 2 - upload and audit a file

First step is to make some temporary changes to allow the code to run locally

Uncomment the seed node information and comment out the remote seed node info. The file should end up looking like this:

```
// For network testing:
// exports.SEED_NODE = ['a678ed17938527be1383388004dbf84246505dbd', { hostname: '167.99.2.1', port: 80 }];
// exports.CLI_SERVER = {host: 'localhost', port: 1800};
// exports.BATNODE_SERVER_PORT = 1900;
// exports.KADNODE_PORT = 80;

// For local testing
exports.SEED_NODE = ['a678ed17938527be1383388004dbf84246505dbd', { hostname: 'localhost', port: 1338 }]
exports.BASELINE_REDUNDANCY = 3;
```

Next, change this line of code in the `while` loop

```
getClosestBatNodeToShard(shardId, callback){
  this.kadenceNode.iterativeFindNode(shardId, (err, res) => {
    let i = 0
    let targetKadNode = res[0]; // res is an array of these tuples: [id, {hostname, port}]
    while (targetKadNode[1].hostname === this.kadenceNode.contact.hostname &&
          (targetKadNode[1].port === this.kadenceNode.contact.port) {
```

to this.

```
    // while (targetKadNode[1].hostname === this.kadenceNode.contact.hostname &&
    while (targetKadNode[1].port === this.kadenceNode.contact.port) {
```

Now we can proceed with the demo.

1. `cd` into `/audit` directory
2. If you haven't already, run `yarn link`  to create a symbolic link between project directory and executable command. This only needs to be done once.
3. Open 3 additional terminal windows or tabs that are also in the `/audit` directory
4. In the first terminal, `cd` into `server` directory. Run `rm/db` first and then run `node node.js`
5. In the second terminal, `cd` into `server2` directory. Run `rm/db` first and then run `node node.js`
6. In the third terminal, `cd` into `client` directory. Run `rm/db` first and then run `node node.js`. This boots up the CLI server which will listen for CLI commands. Wait for a message to log out saying the CLI is ready before issuing any commands.
7. In the fourth terminal, `cd` into `client` as well. Here we can issue `batchain` CLI commands.
8. There should be a example file in the `personal` directory, so run `batchain -u ./personal/example.txt`. Wait a few seconds for the 24 or so shard files to be written to `server` and `server2` `/host` directories.
9. Kill the process manually (Control-C) and run `batchain -a ./manifest/$MANIFESTNAME.batchain`. Replace `$MANIFESTNAME` with the manifest file name generated on `client/manifest` directory.
